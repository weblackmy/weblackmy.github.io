#   问题出现在晚上10点左右, 突然收到阿里云报警, CPU使用率突然飙升, php-fpm进程居高不下, 开始排查.
## ps查看php-fpm进程状态, 有部分fpm进程占用了近40%的cpu, 如图
![](https://weblackmy.github.io/2017-07-01/images/1.jpeg)
## 立刻strace查看进程系统调用, 发现read,brk操作占据大部分, 如图
![](https://weblackmy.github.io/2017-07-01/images/2.jpeg)
## 结合程序, 断定是部分代码频繁读写导致缓存/日志造成, 接着开始查看nginx日志, 找到时间段内的请求URL, 发现2个问题:
*  验证码接口在频繁被刷.
*  APP请求一次上报位置数据太多(近3000个位置信息).

**查代码发现, 验证码接口被刷不应该造成cpu飙升, 二期被刷频率也不是特别夸张, 继续查看位置上传接口, 终于发现问题, 原来是对于每个位置信息, 程序都会读一遍地理配置缓存将坐标转换为省市区格式, 地理配置缓存将近1M, 最终的结果是假设APP一次请求上传1000个位置信息, 程序循环1000次读取配置. 这就是造成brk, read过高的原因.**

#结论
## 对于频繁读取的数据, 应尽量用更搞笑的缓存, 文件缓存在高I/0的情况下, 效率挺差 其次是利用好语言中的static特性, 避免重复执行. 如
`function testFun() {
`    static $data;
`    if (!$data) {
`        $data = 'xxxx';
`    }
`    return $data;
`}
## 一些服务(定位,短信,上传)等应要与主业务区分, 否则万一某一个服务请求量突然过大, 会对主业务产生影响